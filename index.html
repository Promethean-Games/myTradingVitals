<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>myTradingVitals – Multi-Account Import</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0b1020;
      color: #f5f5f5;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 16px;
    }
    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    header span {
      font-size: 0.85rem;
      color: #999;
    }
    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 16px;
      margin-bottom: 16px;
    }
    .panel {
      background: #11162a;
      border-radius: 8px;
      border: 1px solid #242b3f;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.45);
      overflow: hidden;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-bottom: 1px solid #242b3f;
      background: linear-gradient(90deg, #171d33, #151b2e);
    }
    .panel-header h2 {
      font-size: 0.95rem;
      margin: 0;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #d0d6ff;
    }
    .panel-body {
      padding: 10px 12px 12px;
      font-size: 0.9rem;
    }
    label {
      font-size: 0.8rem;
      display: inline-block;
      margin-bottom: 4px;
      color: #c3c7e6;
    }
    input[type="file"],
    input[type="text"],
    select,
    button {
      font-family: inherit;
      font-size: 0.85rem;
    }
    input[type="text"],
    select {
      background: #0b1020;
      border-radius: 4px;
      border: 1px solid #343b57;
      color: #f5f5f5;
      padding: 4px 6px;
      margin-right: 8px;
      margin-bottom: 6px;
      min-width: 160px;
    }
    input[type="file"] {
      margin-bottom: 6px;
    }
    button {
      background: #d11111;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    button:hover {
      background: #f02626;
    }
    button[disabled] {
      opacity: 0.4;
      cursor: default;
    }
    .inline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .help-text {
      font-size: 0.75rem;
      color: #aaa;
      margin-top: 4px;
    }
    .dataset-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed #232840;
      font-size: 0.82rem;
    }
    .dataset-row:last-child {
      border-bottom: none;
    }
    .dataset-name {
      font-weight: 600;
    }
    .dataset-meta {
      font-size: 0.75rem;
      color: #aaa;
      margin-left: 8px;
    }
    .dataset-delete {
      background: transparent;
      border-radius: 999px;
      border: 1px solid #444;
      padding: 0 6px;
      line-height: 1;
      font-size: 0.8rem;
      color: #aaa;
    }
    .dataset-delete:hover {
      border-color: #f44336;
      color: #f44336;
      background: rgba(244, 67, 54, 0.1);
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }
    .metric-card {
      background: #0c1225;
      border-radius: 6px;
      border: 1px solid #272f4b;
      padding: 6px 8px;
    }
    .metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: #9fa4cf;
      letter-spacing: 0.06em;
    }
    .metric-value {
      font-size: 1rem;
      font-weight: 600;
      margin-top: 2px;
    }
    .metric-sub {
      font-size: 0.75rem;
      color: #99a0cc;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    thead {
      background: #151b30;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #242b3f;
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) {
      background: #0b1020;
    }
    tbody tr:nth-child(odd) {
      background: #0f1425;
    }
    .text-right {
      text-align: right;
    }
    .pill {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid #3a415f;
    }
    .pill.green {
      border-color: #4caf50;
      color: #a5e6a8;
    }
    .pill.red {
      border-color: #f44336;
      color: #ffb6a8;
    }
    .pill.blue {
      border-color: #2196f3;
      color: #a0d4ff;
    }
    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .metrics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>myTradingVitals</h1>
    <span>Multi-Account CSV Import · Local-Only</span>
  </header>

  <div class="grid">
    <!-- IMPORT + ACCOUNT FILTER -->
    <section class="panel">
      <div class="panel-header">
        <h2>Import Trades</h2>
      </div>
      <div class="panel-body">
        <div>
          <input type="file" id="csvFileInput" accept=".csv" />
        </div>
        <div class="inline">
          <div>
            <label for="datasetAccountType">Treat this file as</label><br />
            <select id="datasetAccountType">
              <option value="auto">Auto (use tags)</option>
              <option value="Non-Qualified">Non-Qualified (Taxable)</option>
              <option value="Qualified">Qualified (IRA)</option>
            </select>
          </div>
          <div>
            <label for="datasetName">Dataset name</label><br />
            <input type="text" id="datasetName" placeholder="e.g. 6mo Taxable 2025-11-18" />
          </div>
          <div style="align-self: flex-end; padding-bottom: 2px;">
            <button id="importButton">Import CSV</button>
          </div>
        </div>
        <p class="help-text">
          Use your mTV-ready CSVs (Taxable / IRA). You can import multiple files; they’ll be saved in this browser.
        </p>
        <hr style="border-color:#242b3f; margin:8px 0;" />
        <div>
          <label for="accountFilter">Account View</label><br />
          <select id="accountFilter">
            <option value="all">Total (All Accounts)</option>
            <option value="qualified">Qualified (IRA / Tax-Advantaged)</option>
            <option value="nonQualified">Non-Qualified (Taxable)</option>
          </select>
        </div>
        <p class="help-text">
          This filter applies across metrics and tables. Datasets can be toggled individually below.
        </p>
      </div>
    </section>

    <!-- DATASETS PANEL -->
    <section class="panel">
      <div class="panel-header">
        <h2>Datasets</h2>
      </div>
      <div class="panel-body" id="datasetsPanel">
        <!-- populated by JS -->
      </div>
    </section>
  </div>

  <!-- METRICS -->
  <section class="panel" style="margin-bottom: 16px;">
    <div class="panel-header">
      <h2>Key Metrics (Filtered)</h2>
    </div>
    <div class="panel-body">
      <div class="metrics" id="keyMetrics">
        <!-- populated by JS -->
      </div>
    </div>
  </section>

  <!-- TRADES TABLE -->
  <section class="panel">
    <div class="panel-header">
      <h2>Trades (Filtered)</h2>
    </div>
    <div class="panel-body">
      <div style="max-height: 460px; overflow:auto;">
        <table>
          <thead>
          <tr>
            <th>Date</th>
            <th>Ticker</th>
            <th>Dir</th>
            <th>Acct</th>
            <th class="text-right">Size</th>
            <th class="text-right">Entry</th>
            <th class="text-right">Exit</th>
            <th class="text-right">P/L</th>
            <th>Notes</th>
          </tr>
          </thead>
          <tbody id="tradesTableBody">
          <!-- populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
(function() {
  const STORAGE_KEY = "mtv_datasets_v1";

  // id -> { id, name, accountTypeDefault, trades: [...], createdAt }
  let datasets = {};
  let enabledDatasetIds = [];
  let accountFilter = "all"; // "all" | "qualified" | "nonQualified"

  // ---------- CSV PARSER (simple, quote-aware) ----------
  function parseCsvLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const ch = line[i];

      if (ch === '"') {
        if (inQuotes && line[i + 1] === '"') {
          // Escaped quote
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (ch === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += ch;
      }
    }
    result.push(current);
    return result;
  }

  function parseCsvToRows(text) {
    const normalized = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
    const lines = normalized.split("\n").filter(l => l.trim() !== "");
    if (!lines.length) return [];

    const headers = parseCsvLine(lines[0]).map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const fields = parseCsvLine(lines[i]);
      if (fields.length === 1 && fields[0].trim() === "") continue;

      const row = {};
      headers.forEach((h, idx) => {
        row[h] = fields[idx] !== undefined ? fields[idx] : "";
      });
      rows.push(row);
    }
    return rows;
  }

  // ---------- TRADE PARSING ----------
  function parseTradeRow(row, datasetAccountTypeDefault = "auto") {
    const tags = (row.tags || "").trim();

    let rowAccountType = "Non-Qualified";
    if (/\bIRA\b/i.test(tags) || /\(IRA\)/i.test(tags)) {
      rowAccountType = "Qualified";
    }

    let accountType;
    if (datasetAccountTypeDefault === "auto") {
      accountType = rowAccountType;
    } else {
      accountType = datasetAccountTypeDefault; // "Qualified" or "Non-Qualified"
    }

    function toNum(val) {
      if (val === null || val === undefined) return 0;
      if (typeof val === "number") return val;
      const cleaned = String(val).replace(/[^0-9.\-]/g, "");
      if (cleaned === "") return 0;
      const n = parseFloat(cleaned);
      return isNaN(n) ? 0 : n;
    }

    return {
      date: (row.date || "").trim(),
      ticker: (row.ticker || "").trim(),
      direction: (row.direction || "").trim(),
      size: toNum(row.size),
      entry: toNum(row.entry),
      exit: toNum(row.exit),
      stop: (row.stop || "").trim(),
      risk: (row.risk || "").trim(),
      r: (row.r || "").trim(),
      pnl: toNum(row.pnl),
      setup: (row.setup || "").trim(),
      tags,
      confidence: (row.confidence || "").trim(),
      session: (row.session || "").trim(),
      notes: (row.notes || "").trim(),
      accountType
    };
  }

  // ---------- DATASET STORAGE ----------
  function persistDatasets() {
    const payload = {
      datasets,
      enabledDatasetIds
    };
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch (e) {
      console.error("Failed to persist datasets", e);
    }
  }

  function loadDatasetsFromStorage() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      datasets = parsed.datasets || {};
      enabledDatasetIds = parsed.enabledDatasetIds || Object.keys(datasets);
    } catch (e) {
      console.error("Failed to load datasets", e);
    }
  }

  function getAllTradesFromActiveDatasets() {
    const activeDatasets = enabledDatasetIds
      .map(id => datasets[id])
      .filter(Boolean);

    return activeDatasets.flatMap(ds =>
      ds.trades.map(t => ({ ...t, datasetId: ds.id }))
    );
  }

  function getAccountFilteredTrades() {
    const allTrades = getAllTradesFromActiveDatasets();
    if (accountFilter === "all") return allTrades;

    return allTrades.filter(t => {
      const type = t.accountType || "Non-Qualified";
      if (accountFilter === "qualified") return type === "Qualified";
      if (accountFilter === "nonQualified") return type === "Non-Qualified";
      return true;
    });
  }

  function getWorkingTrades() {
    // Placeholder for layering in other filters later (dates, tags, etc.)
    return getAccountFilteredTrades();
  }

  // ---------- METRICS + TABLE ----------
  function formatCurrency(val) {
    if (typeof val !== "number" || isNaN(val)) return "";
    const abs = Math.abs(val);
    const sign = val < 0 ? "-" : "";
    return sign + "$" + abs.toFixed(2);
  }

  function renderKeyMetrics() {
    const container = document.getElementById("keyMetrics");
    if (!container) return;

    const trades = getWorkingTrades();
    const totalTrades = trades.length;
    let totalPnl = 0;
    let winCount = 0;
    let lossCount = 0;

    trades.forEach(t => {
      totalPnl += t.pnl || 0;
      if (t.pnl > 0) winCount++;
      else if (t.pnl < 0) lossCount++;
    });

    const tradeCountForWinRate = winCount + lossCount;
    const winRate = tradeCountForWinRate > 0
      ? (winCount / tradeCountForWinRate) * 100
      : 0;
    const avgPnl = totalTrades > 0 ? totalPnl / totalTrades : 0;

    const avgWin = winCount > 0
      ? trades.filter(t => t.pnl > 0).reduce((sum, t) => sum + t.pnl, 0) / winCount
      : 0;
    const avgLoss = lossCount > 0
      ? trades.filter(t => t.pnl < 0).reduce((sum, t) => sum + t.pnl, 0) / lossCount
      : 0;

    const pnlClass = totalPnl > 0 ? "green" : totalPnl < 0 ? "red" : "blue";

    container.innerHTML = `
      <div class="metric-card">
        <div class="metric-label">Net P/L</div>
        <div class="metric-value">${formatCurrency(totalPnl) || "--"}</div>
        <div class="metric-sub">
          <span class="pill ${pnlClass}">
            ${totalTrades} trades
          </span>
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Win Rate</div>
        <div class="metric-value">${tradeCountForWinRate ? winRate.toFixed(1) + "%" : "--"}</div>
        <div class="metric-sub">
          Wins: ${winCount} · Losses: ${lossCount}
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Avg P/L per Trade</div>
        <div class="metric-value">${totalTrades ? formatCurrency(avgPnl) : "--"}</div>
        <div class="metric-sub">
          Avg Win: ${winCount ? formatCurrency(avgWin) : "--"} · Avg Loss: ${
            lossCount ? formatCurrency(avgLoss) : "--"
          }
        </div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Account View</div>
        <div class="metric-value">${
          accountFilter === "all"
            ? "Total"
            : accountFilter === "qualified"
            ? "Qualified"
            : "Non-Qualified"
        }</div>
        <div class="metric-sub">
          Active datasets: ${enabledDatasetIds.length}
        </div>
      </div>
    `;
  }

  function renderTradesTable() {
    const tbody = document.getElementById("tradesTableBody");
    if (!tbody) return;

    const trades = getWorkingTrades();
    const maxRows = 500; // safety limit
    const slice = trades.slice(0, maxRows);

    tbody.innerHTML = slice
      .map(t => {
        const accountPillClass =
          t.accountType === "Qualified"
            ? "pill blue"
            : "pill";
        const accountLabel =
          t.accountType === "Qualified" ? "Qualified" : "Non-Qual";

        const pnlClass =
          t.pnl > 0 ? "green" : t.pnl < 0 ? "red" : "blue";

        return `
          <tr>
            <td>${t.date || ""}</td>
            <td>${t.ticker || ""}</td>
            <td>${t.direction || ""}</td>
            <td><span class="${accountPillClass}">${accountLabel}</span></td>
            <td class="text-right">${t.size || ""}</td>
            <td class="text-right">${t.entry ? t.entry.toFixed(2) : ""}</td>
            <td class="text-right">${t.exit ? t.exit.toFixed(2) : ""}</td>
            <td class="text-right">
              <span class="pill ${pnlClass}">${t.pnl ? formatCurrency(t.pnl) : ""}</span>
            </td>
            <td>${(t.notes || "").replace(/\[/g, " [")}</td>
          </tr>
        `;
      })
      .join("");

    if (trades.length > maxRows) {
      const extra = trades.length - maxRows;
      const row = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 9;
      td.textContent = `+ ${extra} more rows not shown (performance safeguard)`;
      td.style.fontSize = "0.75rem";
      td.style.color = "#aaa";
      row.appendChild(td);
      tbody.appendChild(row);
    }
  }

  // ---------- DATASETS PANEL ----------
  function renderDatasetsPanel() {
    const container = document.getElementById("datasetsPanel");
    if (!container) return;

    const ids = Object.keys(datasets);
    if (!ids.length) {
      container.innerHTML = `<p class="help-text">No datasets imported yet. Import one or more CSV files above.</p>`;
      return;
    }

    container.innerHTML = "";
    ids.forEach(id => {
      const ds = datasets[id];
      if (!ds) return;
      const isEnabled = enabledDatasetIds.includes(id);
      const tradeCount = ds.trades.length;

      const row = document.createElement("div");
      row.className = "dataset-row";

      const left = document.createElement("div");
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.setAttribute("data-dataset-id", id);
      if (isEnabled) checkbox.checked = true;

      const nameSpan = document.createElement("span");
      nameSpan.className = "dataset-name";
      nameSpan.textContent = ds.name || id;

      const metaSpan = document.createElement("span");
      metaSpan.className = "dataset-meta";
      const acctLabel =
        ds.accountTypeDefault === "Qualified"
          ? "Qualified"
          : ds.accountTypeDefault === "Non-Qualified"
          ? "Non-Qualified"
          : "Mixed/Auto";
      metaSpan.textContent = `${acctLabel} • ${tradeCount} trades`;

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" "));
      label.appendChild(nameSpan);
      label.appendChild(metaSpan);
      left.appendChild(label);

      const delBtn = document.createElement("button");
      delBtn.className = "dataset-delete";
      delBtn.textContent = "×";
      delBtn.setAttribute("data-dataset-id", id);

      row.appendChild(left);
      row.appendChild(delBtn);
      container.appendChild(row);
    });

    container.querySelectorAll("input[type='checkbox']").forEach(chk => {
      chk.addEventListener("change", e => {
        const id = e.target.getAttribute("data-dataset-id");
        if (!id) return;
        if (e.target.checked) {
          if (!enabledDatasetIds.includes(id)) enabledDatasetIds.push(id);
        } else {
          enabledDatasetIds = enabledDatasetIds.filter(x => x !== id);
        }
        persistDatasets();
        renderAllViews();
      });
    });

    container.querySelectorAll(".dataset-delete").forEach(btn => {
      btn.addEventListener("click", e => {
        const id = e.target.getAttribute("data-dataset-id");
        if (!id) return;
        delete datasets[id];
        enabledDatasetIds = enabledDatasetIds.filter(x => x !== id);
        persistDatasets();
        renderDatasetsPanel();
        renderAllViews();
      });
    });
  }

  // ---------- IMPORT HANDLER ----------
  function handleCsvImport(file, options = {}) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target.result;
      const rows = parseCsvToRows(text);
      if (!rows.length) {
        alert("No rows found in CSV.");
        return;
      }

      const datasetAccountTypeDefault = options.accountTypeDefault || "auto";
      const trades = rows.map(row =>
        parseTradeRow(row, datasetAccountTypeDefault)
      );

      const id = "ds_" + Date.now() + "_" + Math.random().toString(36).slice(2, 7);
      const dataset = {
        id,
        name: options.name || file.name,
        accountTypeDefault: datasetAccountTypeDefault,
        trades,
        createdAt: new Date().toISOString()
      };

      datasets[id] = dataset;
      if (!enabledDatasetIds.includes(id)) enabledDatasetIds.push(id);

      persistDatasets();
      renderDatasetsPanel();
      renderAllViews();
    };
    reader.readAsText(file);
  }

  // ---------- MAIN RENDER ----------
  function renderAllViews() {
    renderKeyMetrics();
    renderTradesTable();
  }

  // ---------- INIT ----------
  function init() {
    loadDatasetsFromStorage();
    renderDatasetsPanel();
    renderAllViews();

    const accountSelect = document.getElementById("accountFilter");
    if (accountSelect) {
      accountSelect.addEventListener("change", () => {
        accountFilter = accountSelect.value;
        renderAllViews();
      });
    }

    const importBtn = document.getElementById("importButton");
    const fileInput = document.getElementById("csvFileInput");
    const datasetTypeSelect = document.getElementById("datasetAccountType");
    const datasetNameInput = document.getElementById("datasetName");

    if (importBtn && fileInput) {
      importBtn.addEventListener("click", () => {
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
          alert("Please choose a CSV file to import.");
          return;
        }
        const acctType = datasetTypeSelect ? datasetTypeSelect.value : "auto";
        const name = datasetNameInput ? datasetNameInput.value.trim() : "";
        handleCsvImport(file, {
          accountTypeDefault: acctType,
          name: name || file.name
        });
        // clear file input so same file can be re-imported if needed
        fileInput.value = "";
      });
    }
  }

  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
